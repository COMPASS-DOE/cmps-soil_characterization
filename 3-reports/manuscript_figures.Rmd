---
title: "Synpotic Soil Characterization"
output: 
  github_document:
  html_preview: true
  
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
```

---

```{r}
source("2-code/0-packages.R")
library(ggbiplot)
library(targets)
library(ggh4x)

pal_transect = rev(soilpalettes::soil_palette("redox2", 4))
theme_set(theme_kp())
```

```{r targets}
targets::tar_load(c(data_combined, sample_key))
targets::tar_load_everything()
```

```{r}
reorder_transect = function(dat){
  dat %>% 
    mutate(transect = case_match(transect, "wetland" ~ "marsh", .default = transect),
           transect = factor(transect, levels = c("upland", "transition", "wte", "marsh")))
}

# update transect names in sample_key
sample_key = 
  sample_key %>% 
  reorder_transect()

```


```{r data_processing}
make_data_subset = function(data_combined){
  
 # data_combined_subset = 
    data_combined %>% 
    reorder_transect() %>% 
    filter(!transect %in% "wte") %>% 
    force()
}
make_data_wide = function(data_combined_subset, sample_key){
  
  #data_combined_wide = 
    data_combined_subset %>% 
    dplyr::select(sample_label, analysis, name, value) %>% 
    separate(name, sep = "_", into = "variable", remove = F) %>% 
    dplyr::select(sample_label, variable, value) %>% 
    pivot_wider(names_from = "variable") %>% 
    left_join(sample_key) %>% 
    filter(!grepl("016", sample_label)) %>% # this one sample is very weird
    force()
  
}


data_combined_subset = make_data_subset(data_combined)

data_combined_wide = make_data_wide(data_combined_subset, sample_key) %>% 
  dplyr::select(-gwc) %>% 
    rename(CEC = cec,
         NH4N = nh4n,
         NO3N = no3n,
         P = mehlichp,
         WEOC = npoc,
         DIC = dic,
         SOM = percentOM)

data_wide_PCA = 
  data_combined_wide %>% 
  dplyr::select(-c("DIC", "SOM"))

print("df created: `data_combined_wide`, `data_wide_PCA`")
```

---

## Site Map

```{r map, fig.height = 9.5, fig.width = 13}

library(sf) # for map
library(ggspatial) # for north arrow


## Set CRS
common_crs <- 4326

## Set map size and point size
point_size <- 2
map_width = 9
map_height = 6

## Set regional and WLE/CB (inset) bounding boxes
us_bbox <- c(xmin = -125, xmax = -60, ymin = 20, ymax = 50)
region_bbox <- c(xmin = -98, xmax = -60, ymin = 32, ymax = 50)
cb_bbox <- c(xmin = -77.8, xmax = -74.5, ymin = 36.8, ymax = 40.5)
wle_bbox <- c(xmin = -84, xmax = -82, ymin = 41, ymax = 42)

## Make US states map cropped to GL/CB region
us <- 
  read_sf("cb_2018_us_state_5m/cb_2018_us_state_5m.shp") %>% 
  st_transform(., crs = common_crs) %>% 
  st_crop(., y = us_bbox)

region <- st_crop(us, y = region_bbox)

## Further crop states to WLE/CB region
cb_states <- st_crop(region, y = cb_bbox)
wle_states <- st_crop(region, y = wle_bbox)

## Get state labels
st_labels = st_centroid(us) %>% 
  filter(!STUSPS %in% c("TN", "NC", "DC")) # remove state labels that mess with the graph

## create a df with site coordinates and labels
sites = data.frame(
  y = c(41.61524, 41.50148, 41.37618,
        38.43085, 37.21927, 38.874445),
  x = c(-83.22889, -83.04611, -82.50685,
        -76.22622, -76.40851, -76.551667),
  region = c("Erie", "Erie", "Erie",
             "Chesapeake", "Chesapeake", "Chesapeake"),
  site = c("CRC", "PTR", "OWC",
           "MSM", "GWI", "GCW"),
  label = c("1", "2", "3", 
            "5", "6", "4"))

## Make the base map
base_plot <- 
  ggplot() + 
  geom_sf(data = region) + 
  #   geom_sf_text(data = st_labels, aes(label = STUSPS))+
  geom_point(
    data = sites, aes(x, y),
    size = 2, color = "black")+
  # CB inset rectangle
  geom_rect(aes(xmin = -77.8, xmax = -74.5, ymin = 36.8, ymax = 40.5), 
            fill = NA, color = "black", lwd = 0.75) +
  geom_segment(aes(x = -74.5, xend = -70, y = 38, yend = 38), 
               color = "black", lwd = 0.75) + 
  # WLE inset rectangle
  geom_rect(aes(xmin = -84, xmax = -82, ymin = 41, ymax = 42), 
            fill = NA, color = "black", lwd = 0.75) +
  geom_segment(aes(x = -83, xend = -83, y = 42, yend = 44), 
               color = "black", lwd = 0.75) + 
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering)+
  xlim(-92, -67)+
  ylim(35, 49)+
  theme(legend.background = element_rect(fill = alpha("white", 0.0)), 
        legend.key = element_rect(fill = "transparent"), 
        legend.position = c(0.85, 0.1)) + 
  labs(x = "", y = "")+
  NULL

## Make the inset map with just WLE sites
inset_plot_wle <- 
  ggplot() + 
  geom_sf(data = wle_states) + 
  geom_point(
    data = sites %>% filter(region == "Erie"), aes(x, y),
    size = 5, color = "black")+
  geom_text(data = sites %>% filter(region == "Erie"), aes(x, y, label = label), nudge_x = 0, nudge_y = -0.10, size = 7)+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0))+
  cowplot::theme_map() + 
  theme(legend.position = "none",
        panel.background = element_rect(fill = "#56cfe1"),
        panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        axis.text = element_blank()) 

## Make the inset map with just CB sites
inset_plot_cb <- 
  ggplot() + 
  geom_sf(data = cb_states) + 
  geom_point(
    data = sites %>% filter(region == "Chesapeake"), aes(x, y),
    size = 5, color = "black")+
  geom_text(data = sites %>% filter(region == "Chesapeake"), aes(x, y, label = label), nudge_x = -0.25, nudge_y = -0.00, size = 7)+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0))+
  cowplot::theme_map() + 
  theme(legend.position = "none",
        panel.background = element_rect(fill = "#48bfe3"),
        panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        axis.text = element_blank()) 

## Combine into single figure
base_plot + 
  annotation_custom(
    ggplotGrob(inset_plot_wle), 
    xmin = -90, xmax = -80, ymin = 42, ymax = 50)+
  annotation_custom(
    ggplotGrob(inset_plot_cb), 
    xmin = -75, xmax = -65, ymin = 35, ymax = 43)+
  theme_kp()

# save figure 1300 x 950
```

```{r map-poster, fig.height = 9.5, fig.width = 13, eval=FALSE}

library(sf) # for map
library(ggspatial) # for north arrow


## Set CRS
common_crs <- 4326

## Set map size and point size
point_size <- 2
map_width = 9
map_height = 6

## Set regional and WLE/CB (inset) bounding boxes
us_bbox <- c(xmin = -125, xmax = -60, ymin = 20, ymax = 50)
region_bbox <- c(xmin = -98, xmax = -60, ymin = 32, ymax = 50)
cb_bbox <- c(xmin = -77.8, xmax = -74.5, ymin = 36.8, ymax = 40.5)
wle_bbox <- c(xmin = -84, xmax = -82, ymin = 41, ymax = 42)

## Make US states map cropped to GL/CB region
us <- 
  read_sf("cb_2018_us_state_5m/cb_2018_us_state_5m.shp") %>% 
  st_transform(., crs = common_crs) %>% 
  st_crop(., y = us_bbox)

region <- st_crop(us, y = region_bbox)

## Further crop states to WLE/CB region
cb_states <- st_crop(region, y = cb_bbox)
wle_states <- st_crop(region, y = wle_bbox)

## Get state labels
st_labels = st_centroid(us) %>% 
  filter(!STUSPS %in% c("TN", "NC", "DC")) # remove state labels that mess with the graph

## create a df with site coordinates and labels
sites = data.frame(
  y = c(41.61524, 41.50148, 41.37618,
        38.43085, 37.21927, 38.874445),
  x = c(-83.22889, -83.04611, -82.50685,
        -76.22622, -76.40851, -76.551667),
  region = c("Erie", "Erie", "Erie",
             "Chesapeake", "Chesapeake", "Chesapeake"),
  site = c("CRC", "PTR", "OWC",
           "MSM", "GWI", "GCW"),
  label = c("1", "2", "3", 
            "5", "6", "4"))

## Make the base map
base_plot <- 
  ggplot() + 
  geom_sf(data = region) + 
  #   geom_sf_text(data = st_labels, aes(label = STUSPS))+
  geom_point(
    data = sites, aes(x, y),
    size = 2, color = "black")+
  # CB inset rectangle
  geom_rect(aes(xmin = -77.8, xmax = -74.5, ymin = 36.8, ymax = 40.5), 
            fill = NA, color = "black", lwd = 0.75) +
  geom_segment(aes(x = -74.5, xend = -70, y = 38, yend = 38), 
               color = "black", lwd = 0.75) + 
  # WLE inset rectangle
  geom_rect(aes(xmin = -84, xmax = -82, ymin = 41, ymax = 42), 
            fill = NA, color = "black", lwd = 0.75) +
  geom_segment(aes(x = -83, xend = -83, y = 42, yend = 44), 
               color = "black", lwd = 0.75) + 
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering)+
  xlim(-92, -67)+
  ylim(35, 49)+
#  scale_x_continuous(labels = NULL)+
#  scale_y_continuous(labels = NULL)+
  theme(legend.background = element_rect(fill = alpha("white", 0.0)), 
        legend.key = element_rect(fill = "transparent"), 
        legend.position = c(0.85, 0.1),
        axis.text = element_blank()) + 
  labs(x = "", y = "")+
  theme_void()+
  NULL

## Make the inset map with just WLE sites
inset_plot_wle <- 
  ggplot() + 
  geom_sf(data = wle_states) + 
  geom_point(
    data = sites %>% filter(region == "Erie"), aes(x, y),
    size = 5, color = "black")+
  geom_text(data = sites %>% filter(region == "Erie"), aes(x, y, label = label), nudge_x = 0, nudge_y = -0.10, size = 7)+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0))+
  cowplot::theme_map() + 
  theme(legend.position = "none",
        panel.background = element_rect(fill = "#56cfe1"),
        panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        axis.text = element_blank()) 

## Make the inset map with just CB sites
inset_plot_cb <- 
  ggplot() + 
  geom_sf(data = cb_states) + 
  geom_point(
    data = sites %>% filter(region == "Chesapeake"), aes(x, y),
    size = 5, color = "black")+
  geom_text(data = sites %>% filter(region == "Chesapeake"), aes(x, y, label = label), nudge_x = -0.25, nudge_y = -0.00, size = 7)+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0))+
  cowplot::theme_map() + 
  theme(legend.position = "none",
        panel.background = element_rect(fill = "#48bfe3"),
        panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        axis.text = element_blank()) 

## Combine into single figure
base_plot + 
  annotation_custom(
    ggplotGrob(inset_plot_wle), 
    xmin = -90, xmax = -80, ymin = 42, ymax = 50)+
  annotation_custom(
    ggplotGrob(inset_plot_cb), 
    xmin = -75, xmax = -65, ymin = 35, ymax = 43)

# save figure 1300 x 950
```


---

## 0. Correlations

```{r gg_corr, fig.height=8, fig.width=8}

fit_correlations_function = function(dat, TITLE){
  num = 
    dat %>%       
    dplyr::select(where(is.numeric)) %>%
    drop_na()
  
  num_clean = 
    num %>% 
    rownames_to_column("row") %>% 
    pivot_longer(-row) %>% 
    separate(name, sep = "_", into = c("name")) %>% 
    pivot_wider() %>% 
    dplyr::select(-row)
  
  
  m = cor(num_clean)
  m = round(m, 1)
  
  p.mat <- ggcorrplot::cor_pmat(num_clean)
  ggcorrplot::ggcorrplot(m, type = "lower",
                         hc.order = TRUE,
                         p.mat = p.mat,
                         outline.color = "black",
                         lab = TRUE, 
                         insig = "blank",
                         #colors = c("#E46726", "white", "#6D9EC1"),
  ) +
    scale_fill_gradient2(low = "orangered2", mid = "white", high = "turquoise4", limit = c(-1, 1), midpoint = 0)+
    theme(legend.position = "none")
  
}

corr_all = fit_correlations_function(dat = data_wide_PCA)
#corr_wle = fit_correlations_function(dat = data_wide_PCA %>% filter(region == "Erie"), TITLE = "Erie" )
#corr_cb = fit_correlations_function(dat = data_wide_PCA %>% filter(region == "Chesapeake"), TITLE = "Chesapeake")

corr_all
```

Highly correlated variables include:

- (+) TC & WEOC, TN
- (+) TS & Chloride, Sulfate, Na, CEC
- (+) CEC & TS, Na, K, Mg, SpConductance
- (+) Na & SpConductance, TS, K, Mg
- (+) Chloride & Sulfate, TS, CEC, SpConductance, Na
- (-) pH & WEOC, Al
- (-) Ca and Al

---

# VERSION 1: ALL ANALYTES

<details>
  <summary> Click to Open </summary>
  
## 1. PCAs

```{r pca_function}
fit_pca_function = function(dat){
  
  dat %>% 
    drop_na()
  
  num = 
    dat %>%       
    dplyr::select(where(is.numeric)) %>%
    dplyr::mutate(row = row_number()) %>% 
    drop_na()
  
  num_row_numbers = num %>% dplyr::select(row)
  
  grp = 
    dat %>% 
    dplyr::select(where(is.character) | where(is.factor)) %>% 
    dplyr::mutate(row = row_number()) %>% 
    right_join(num_row_numbers)
  
  
  num = num %>% dplyr::select(-row)
  pca_int = prcomp(num, scale. = T)
  
  list(num = num,
       grp = grp,
       pca_int = pca_int)
}
```

--- 

### Overall PCAs

```{r pca_input}
pca_overall = fit_pca_function(dat = data_wide_PCA) 
pca_overall_wle = fit_pca_function(dat = data_wide_PCA %>% filter(region == "Erie"))
pca_overall_cb = fit_pca_function(data_wide_PCA %>% filter(region == "Chesapeake"))
```



### PCA with clusters


```{r cluster_calc, include=FALSE}

#library(cluster)
library(factoextra)


df = data_wide_PCA %>%   drop_na() %>% dplyr::select(where(is.numeric))
grp = data_wide_PCA %>% drop_na() %>% dplyr::select(!where(is.numeric))

fviz_nbclust(df, FUN = hcut, method = "wss")
fviz_nbclust(df, FUN = hcut, method = "silhouette")
# three clusters

d <- dist(df, method = "euclidean")
hc1 <- hclust(d, method = "complete" )
plot(hc1, cex = 0.6, hang = -1)
hc5 <- hclust(d, method = "ward.D2" )
sub_grp <- cutree(hc5, k = 3)
table(sub_grp)
plot(hc5, cex = 0.6)
rect.hclust(hc5, k = 3, border = 2:5)

df_cl <- mutate(df, cluster = sub_grp) %>% cbind(grp) %>% mutate(cluster = as.character(cluster))
count(df_cl,cluster)

```

```{r cluster_gg, eval=FALSE}
df_cl %>%
  ggplot(aes(y = cluster, x = site))+
  geom_point(aes(color = transect, shape = transect),
             size = 4, stroke = 1,
             position = position_jitterdodge(jitter.width = 0.0, jitter.height = 0.1, 
                                             dodge.width = 0.4))+
  scale_color_manual(values = pal_transect)

```



```{r cluster_pca, fig.width=10, fig.height=6}
library(ggConvexHull)

pca_cluster = fit_pca_function(df_cl) 

ggbiplot::ggbiplot(pca_cluster$pca_int, obs.scale = 1, var.scale = 1,
                   groups = as.character(pca_cluster$grp$cluster), 
                   ellipse = F, circle = FALSE, var.axes = TRUE, alpha = 0) +
  geom_convexhull(aes(group = pca_cluster$grp$cluster,
                      fill = pca_cluster$grp$cluster), alpha = 0.2)+
  geom_point(size=4,stroke=1, alpha = 1,
             aes(shape = pca_cluster$grp$region,
                 fill = groups))+ 
  scale_shape_manual(values = c(23, 21))+
  scale_color_manual(values = pnw_palette("Sailboat", 3))+
  scale_fill_manual(values = pnw_palette("Sailboat", 3))+
  labs(fill="cluster",
       color = "cluster",
       shape = "region",
       title = "Overall PCA, both regions",
       subtitle = "Surface horizons only")+
  theme_kp()+
  NULL
  
```

```{r pca_gg, fig.width=10, fig.height=6, eval=FALSE}
## PCA plots overall
#gg_pca_overall = 
ggbiplot(pca_overall$pca_int, obs.scale = 1, var.scale = 1,
         groups = as.character(pca_overall$grp$region), 
         ellipse = TRUE, circle = FALSE, var.axes = TRUE, alpha = 0) +
  geom_point(size=4,stroke=1, alpha = 1,
             aes(shape = pca_overall$grp$region,
                 fill = groups))+ 
  scale_color_manual(values = c("#16879C", "#BB281E"))+
  scale_fill_manual(values = c("#16879C", "#BB281E"))+
  scale_shape_manual(values = c(23, 21))+
  labs(shape="",
       title = "Overall PCA, both regions",
       subtitle = "Surface horizons only")+
  theme_kp()+
  guides(fill = "none")+
  NULL

```

```{r pca_gg_regions, fig.width=10, fig.height=6}

gg_pca_wle = 
  ggbiplot(pca_overall_wle$pca_int, obs.scale = 1, var.scale = 1,
           groups = as.character(pca_overall_wle$grp$transect), 
           ellipse = TRUE, circle = FALSE, var.axes = TRUE, alpha = 1) +
  geom_point(size=3,stroke=1, alpha = 1,
             aes(shape = pca_overall_wle$grp$site,
                 color = groups))+ 
  scale_color_manual(breaks = c("upland", "transition", "wte", "marsh"), 
                     values = pal_transect)+
  xlim(-6,6)+
  ylim(-4.5,4.5)+
  labs(shape="",
       title = "PCA: Erie",
       subtitle = "surface horizons")+
  theme_kp()+
  theme(legend.position = "top", legend.box = "vertical")+
  NULL

gg_pca_cb = 
  ggbiplot(pca_overall_cb$pca_int, obs.scale = 1, var.scale = 1,
           groups = as.character(pca_overall_cb$grp$transect), 
           ellipse = TRUE, circle = FALSE, var.axes = TRUE, alpha = 0) +
  geom_point(size=3,stroke=1, alpha = 1,
             aes(shape = pca_overall_cb$grp$site,
                 color = groups))+ 
  scale_color_manual(breaks = c("upland", "transition", "wte", "marsh"), 
                     values = pal_transect)+
  xlim(-5.5,7.5)+
  ylim(-5,5)+
  labs(shape="",
       title = "PCA: Chesapeake",
       subtitle = "surface horizons")+
  theme_kp()+
  theme(legend.position = "top", legend.box = "vertical")+
  NULL

gg_pca_regions = cowplot::plot_grid(gg_pca_wle , gg_pca_cb)
gg_pca_regions

```


### Drivers and loadings

```{r pc_loadings}
get_pc_values = function(dat){
  
  pca = fit_pca_function(dat)
  
  x = pca$pca_int$rotation
  x2 = 
    x %>% 
    as.data.frame() %>% 
    dplyr::select(PC1) %>% 
    arrange(desc(PC1)) %>% 
    rownames_to_column("variable") %>% 
    mutate(variable = fct_reorder(variable, (PC1)))

  x2
}

pc_overall = get_pc_values(data_wide_PCA) %>% mutate(region = "combined")
pc_wle = get_pc_values(data_wide_PCA %>% filter(region == "Erie")) %>% mutate(region = "Erie")
pc_cb = get_pc_values(data_wide_PCA %>% filter(region == "Chesapeake")) %>% mutate(region = "Chesapeake")

```

```{r pc_gg, fig.height=8, fig.width=6}

pc_all = 
  bind_rows(pc_overall, pc_wle, pc_cb) %>% 
  mutate(variable = fct_reorder(variable, (PC1)))

overall = 
  pc_all %>% 
  filter(region == "combined") %>% 
  mutate(variable = fct_reorder(variable, abs(PC1))) %>% 
  ggplot(aes(x = abs(PC1), y = variable))+
  geom_point(size = 5, stroke = 1, aes(shape = region, fill = region))+
  scale_fill_manual(values = c("#16879C", "#BB281E" ))+
  scale_shape_manual(values = c(23, 21))+
  
  xlim(-0.4, 0.4)+
  geom_vline(xintercept = 0)+
  labs(y = "")+
  theme_kp()

non_absolute = 
  pc_all %>% 
  mutate(variable = fct_reorder(variable, (PC1))) %>% 
  filter(region != "combined") %>% 
  ggplot(aes(x = PC1, y = variable))+
  geom_point(size = 5, stroke = 1, aes(shape = region, fill = region))+
  scale_fill_manual(values = c("#16879C", "#BB281E" ))+
  scale_shape_manual(values = c(23, 21))+
  
  xlim(-0.4, 0.4)+
  geom_vline(xintercept = 0)+
  labs(y = "")+
  theme_kp()

pc_all %>% 
  filter(region != "combined") %>% 
  mutate(variable = fct_reorder(variable, abs(PC1))) %>% 
  ggplot(aes(x = abs(PC1), y = variable))+
  geom_point(size = 5, stroke = 1, aes(shape = region, fill = region))+
  scale_fill_manual(values = c("#16879C", "#BB281E" ))+
  scale_shape_manual(values = c(23, 21))+
  labs(y = "",
       x = "|PC1|")+
  theme_kp()

```



---


## 1b. PERMANOVA

```{r}
library(vegan)

adonis2((data_wide_PCA %>% dplyr::select(where(is.numeric)) %>% drop_na()) ~ 
         (region + transect + horizon + site)^2, 
       data = data_wide_PCA %>% drop_na)

```


## 2. Each analyte

```{r scaled_gg1, fig.height = 8, fig.width = 7, eval=FALSE}
data_long = 
  data_combined_wide %>% 
  rename(Cl = Chloride,
         SO4 = Sulfate) %>% 
  pivot_longer(cols = -c(sample_label, region, site, transect, tree_number, horizon)) %>% 
  filter(!is.na(value))

data_scaling_max_min = 
  data_long %>% 
  filter(transect != "transition") %>% 
  group_by(region, site, transect, horizon, name) %>% 
  dplyr::summarise(value = mean(value)) %>% 
  group_by(region, site, horizon, name) %>% 
  dplyr::summarise(max = max(value, na.rm = T),
                   min = min(value, na.rm = T))

data_scaled2 = 
  data_long %>% 
  group_by(region, site, transect, horizon, name) %>% 
  dplyr::summarise(value = mean(value)) %>% 
  left_join(data_scaling_max_min) %>% 
  mutate(scaled = (value - min) / (max - min)) %>% 
  dplyr::select(region, site, transect, horizon, name, scaled) %>%
  pivot_wider(names_from = "transect", values_from = "scaled") %>% 
  mutate(correction = case_when(upland < marsh ~ 1,
                                upland > marsh ~ -1)) %>% 
  pivot_longer(cols = c(upland, marsh, transition), names_to = "transect", values_to = "scaled") %>% 
  mutate(scaled = scaled * correction,
         scaled = case_when(transect == "upland" ~ 0,
                            transect == "marsh" ~ 1,
                            TRUE ~ scaled),
         scaled2 = case_when(scaled > 4 ~ 4,
                             scaled < -1 ~ -1,
                             TRUE ~ scaled),
         label = case_when(scaled > 4 | scaled < -1 ~ round(scaled,1))) %>% 
  # order analytes
  mutate(name = factor(name, levels = c("TC", "TN", "TS", "SOM",
                                        "pH", "spConductance",
                                        "WEOC", "DIC",
                                        "Fe", "P",
                                        "Ca", "Mg", "Na", "K", "Al", "CEC",
                                        "NH4N", "NO3N", "Cl", "SO4")),
         site = factor(site, levels = c("CRC", "PTR", "OWC",
                                        "GCW", "MSM", "GWI")))

data_scaled2 %>%
  ggplot(aes(x = scaled2, y = name))+
  geom_segment(aes(x = 0, xend = scaled2, yend = name), 
               color = "black", linetype = "dashed", linewidth = 0.2)+
  geom_segment(aes(x = 0, xend = 1, yend = name), color = "black")+
  geom_point(data = data_scaled2 %>% filter(transect != "transition"),
             color = "black",
             size = 1)+
  geom_point(data = data_scaled2 %>% filter(transect == "transition"), 
             size = 4, aes(color = site), stroke = 1, shape = 21, fill = "white")+
  annotate("text", label = "U", x = 0, y = 21)+
  annotate("text", label = "M", x = 1, y = 21)+
  annotate("text", label = "", x = 1, y = 21.5)+
  xlim(-1, 5)+
  scale_y_discrete(limits = rev)+
  scale_shape_manual(breaks = c("CRC", "PTR", "OWC", "GCW", "MSM", "GWI"), 
                     values = c(21, 22, 24, 21, 22, 24))+
  labs(x = "",
       y = "",
       shape = "transition soils at")+
  facet_wrap(~region)+
  theme_kp()+
  theme(panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "right",
        legend.background = element_blank()
  )

```

### Normalized values - v2

```{r scaled_gg2, fig.height = 8, fig.width = 8}
data_long_all = 
  data_combined_wide %>% 
  pivot_longer(cols = -c(sample_label, region, site, transect, tree_number, horizon)) %>% 
  filter(!is.na(value))

data_scaled_NEW = 
  data_long_all %>% 
  group_by(region, site, horizon, transect, name) %>% 
  dplyr::summarise(value_scaled = median(value)) %>% 
  group_by(region, site, horizon, name) %>% 
  dplyr::mutate(value_scaled = scales::rescale(value_scaled)) %>% 
  mutate(transect = factor(transect, levels = c("upland", "transition", "wetland")))

data_scaled_NEW %>% 
  ggplot(aes(x = transect, y = value_scaled, group = site, color = site))+
  geom_line(linewidth = 1) + geom_point(size = 2)+
  facet_wrap( ~ name)+
  scale_color_manual(breaks = c("CRC", "PTR", "OWC",
                                "GCW", "MSM", "GWI"),
                     values = c("#d73027", "#fc8d59", "#fdbb84", 
                                "#74a9cf", "#2b8cbe", "#045a8d"))+
  scale_x_discrete(labels = c("U", "T" , "M" ))+
  labs(x = "Transect", y = "Normalized concentration")+
  theme_kp()+
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank())

```

```{r scaled_gg2_split, fig.height = 16, fig.width = 18}
library(ggh4x) # for nested facets
# https://teunbrand.github.io/ggh4x/reference/facet_nested.html

data_scaled_NEW %>% 
  ggplot(aes(x = transect, y = value_scaled, group = site, color = site))+
  geom_line(linewidth = 1) + geom_point(size = 2)+
#  facet_wrap( ~ name)+
  facet_nested_wrap(~ name + region, ncol = 8,
                    nest_line = element_line(colour = "grey"))+ 
  scale_color_manual(breaks = c("CRC", "PTR", "OWC",
                                "GCW", "MSM", "GWI"),
                     values = c("#d73027", "#fc8d59", "#fdbb84", 
                                "#74a9cf", "#2b8cbe", "#045a8d"))+
  scale_x_discrete(labels = c("U", "T" , "M" ))+
  labs(x = "Transect", y = "Normalized concentration")+
  theme_kp()+
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank())
```



### GWI only

```{r scaled_gg2_gwi, fig.height = 8, fig.width = 8}
data_scaled_NEW %>% 
  filter(site == "GWI") %>% 
  ggplot(aes(x = transect, y = value_scaled, group = site, color = site))+
  geom_line(linewidth = 1) + geom_point(size = 2)+
  facet_wrap( ~ name + region)+
  scale_color_manual(breaks = c("CRC", "PTR", "OWC",
                                "GCW", "MSM", "GWI"),
                     values = c("#d73027", "#fc8d59", "#fdbb84", 
                                "#74a9cf", "#2b8cbe", "#045a8d"))+
  scale_x_discrete(labels = c("U", "T" , "M" ))+
  labs(x = "Transect", y = "Normalized concentration")+
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank())

```


</details>


# VERSION 2: DROPPING CORRELATED ANALYTES

### Overall PCAs

```{r drop}
# drop correlated analytes

data_wide_PCA2 = data_wide_PCA %>% 
  dplyr::select(-c(TN, CEC, K, Mg, Sulfate, NO3N, pH, spConductance))
```



```{r v2-pca_input}
pca_overall = fit_pca_function(data_wide_PCA2) 
pca_overall_wle = fit_pca_function(dat = data_wide_PCA2 %>% filter(region == "Erie"))
pca_overall_cb = fit_pca_function(data_wide_PCA2 %>% filter(region == "Chesapeake"))
```

### PCA with clusters

```{r v2-cluster_calc, include=FALSE}

#library(cluster)
library(factoextra)


df = data_wide_PCA2 %>%   drop_na() %>% dplyr::select(where(is.numeric))
grp = data_wide_PCA2 %>% drop_na() %>% dplyr::select(!where(is.numeric))

fviz_nbclust(df, FUN = hcut, method = "wss")
fviz_nbclust(df, FUN = hcut, method = "silhouette")
# three clusters

d <- dist(df, method = "euclidean")
hc1 <- hclust(d, method = "complete" )
plot(hc1, cex = 0.6, hang = -1)
hc5 <- hclust(d, method = "ward.D2" )
sub_grp <- cutree(hc5, k = 3)
table(sub_grp)
plot(hc5, cex = 0.6)
rect.hclust(hc5, k = 3, border = 2:5)

df_cl <- mutate(df, cluster = sub_grp) %>% cbind(grp) %>% mutate(cluster = as.character(cluster))
count(df_cl,cluster)

```

```{r v2-cluster_gg, include=FALSE}
df_cl %>%
  ggplot(aes(y = cluster, x = site))+
  geom_point(aes(color = transect, shape = transect),
             size = 4, stroke = 1,
             position = position_jitterdodge(jitter.width = 0.0, jitter.height = 0.1, 
                                             dodge.width = 0.4))+
  scale_color_manual(values = pal_transect)

```

```{r v2-cluster_pca, fig.width=10, fig.height=6}
library(ggConvexHull)

pca_cluster = fit_pca_function(df_cl) 

ggbiplot::ggbiplot(pca_cluster$pca_int, obs.scale = 1, var.scale = 1, varname.size = 5,
                   groups = as.character(pca_cluster$grp$cluster), 
                   ellipse = F, circle = FALSE, var.axes = TRUE, alpha = 0) +
  geom_convexhull(aes(group = pca_cluster$grp$cluster,
                      fill = pca_cluster$grp$cluster), alpha = 0.2)+
  geom_point(size=4,stroke=1, alpha = 1,
             aes(shape = pca_cluster$grp$region,
                 fill = groups))+ 
  scale_shape_manual(values = c(23, 21))+
  scale_color_manual(values = pnw_palette("Sailboat", 3))+
  scale_fill_manual(values = pnw_palette("Sailboat", 3))+
  labs(fill="cluster",
       color = "cluster",
       shape = "region")+
  theme_kp()+
  theme(legend.position = c(0.8, 0.75))+
  guides(fill = guide_legend(override.aes = list(shape = 21)))+
  NULL
  
```


---

## PCA by region

```{r v2-pca_gg_regions, fig.width=12, fig.height=7}

gg_pca_wle = 
  ggbiplot(pca_overall_wle$pca_int, obs.scale = 1, var.scale = 1, varname.size = 5,
           groups = as.character(pca_overall_wle$grp$transect), 
           ellipse = TRUE, circle = FALSE, var.axes = TRUE, alpha = 1) +
  geom_point(size=5,stroke=1, alpha = 1,
             aes(shape = pca_overall_wle$grp$site,
                 fill = groups), 
             stroke = 1)+ 
  scale_color_manual(breaks = c("upland", "transition", "wte", "marsh"), 
                     values = pal_transect)+
  scale_fill_manual(breaks = c("upland", "transition", "wte", "marsh"), 
                    values = pal_transect)+
  scale_shape_manual(values = c(21, 24, 22))+
  xlim(-3, 5)+
  ylim(-2.5, 3.5)+
  labs(shape="", fill = "", color = "")+ 
  theme_kp()+
  theme(legend.position = "top", legend.box = "vertical",
        axis.text = element_text(size = 16, color = "black"),
        axis.title = element_text(size = 16, face = "bold", color = "black"),
  )+
  guides(fill = guide_legend(override.aes = list(alpha=1, shape = 21, size = 3)))+
  NULL

gg_pca_cb = 
  ggbiplot(pca_overall_cb$pca_int, obs.scale = 1, var.scale = 1, varname.size = 5,
           groups = as.character(pca_overall_cb$grp$transect), 
           ellipse = TRUE, circle = FALSE, var.axes = TRUE, alpha = 0) +
  geom_point(size=5,stroke=1, alpha = 1,
             aes(shape = pca_overall_cb$grp$site,
                 fill = groups), 
             stroke = 1)+ 
  scale_color_manual(breaks = c("upland", "transition", "wte", "marsh"), 
                     values = pal_transect)+
  scale_fill_manual(breaks = c("upland", "transition", "wte", "marsh"), 
                    values = pal_transect)+
  scale_shape_manual(values = c(21, 24, 22))+
  xlim(-5, 3)+
  ylim(-2.5, 3.5)+
  labs(shape="", fill = "", color = "")+ 
  theme_kp()+
  theme(legend.position = "top", legend.box = "vertical",
        axis.text = element_text(size = 16, color = "black"),
        axis.title = element_text(size = 16, face = "bold", color = "black"),
  )+
  guides(fill = guide_legend(override.aes = list(alpha=1, shape = 21, size = 3)))+
  NULL

gg_pca_regions = cowplot::plot_grid(gg_pca_wle , gg_pca_cb, nrow = 1,
                                    labels = c("A: Erie", "B: Chesapeake"))
gg_pca_regions

```

```{r v2-pca_gg_regions-poster, fig.width=7, fig.height=7, eval=FALSE}

gg_pca_wle = 
  ggbiplot(pca_overall_wle$pca_int, obs.scale = 1, var.scale = 1, varname.size = 5,
           groups = as.character(pca_overall_wle$grp$transect), 
           ellipse = TRUE, circle = FALSE, var.axes = TRUE, alpha = 1) +
  geom_point(size=5,stroke=1, alpha = 1,
             aes(shape = pca_overall_wle$grp$site,
                 fill = groups), 
             stroke = 1)+ 
  scale_color_manual(breaks = c("upland", "transition", "wte", "marsh"), 
                     values = pal_transect)+
  scale_fill_manual(breaks = c("upland", "transition", "wte", "marsh"), 
                    values = pal_transect)+
  scale_shape_manual(values = c(21, 24, 22))+
  xlim(-3, 5)+
  ylim(-2.5, 3.5)+
  labs(shape="", fill = "", color = "", title = "Lake Erie")+ 
  theme_kp()+
  theme(legend.position = "top", legend.box = "vertical",
        plot.title = element_text(face = "bold", size = 18))+
  guides(fill = guide_legend(override.aes = list(alpha=1, shape = 21, size = 3)))+
  NULL

gg_pca_cb = 
  ggbiplot(pca_overall_cb$pca_int, obs.scale = 1, var.scale = 1, varname.size = 5,
           groups = as.character(pca_overall_cb$grp$transect), 
           ellipse = TRUE, circle = FALSE, var.axes = TRUE, alpha = 0) +
  geom_point(size=5,stroke=1, alpha = 1,
             aes(shape = pca_overall_cb$grp$site,
                 fill = groups), 
             stroke = 1)+ 
  scale_color_manual(breaks = c("upland", "transition", "wte", "marsh"), 
                     values = pal_transect)+
  scale_fill_manual(breaks = c("upland", "transition", "wte", "marsh"), 
                    values = pal_transect)+
  scale_shape_manual(values = c(21, 24, 22))+
  xlim(-5, 3)+
  ylim(-2.5, 3.5)+
  labs(shape="", fill = "", color = "", title = "Chesapeake Bay")+ 
  theme_kp()+
  theme(legend.position = "top", legend.box = "vertical",
        plot.title = element_text(face = "bold", size = 18))+
  guides(fill = guide_legend(override.aes = list(alpha=1, shape = 21, size = 3)))+
  NULL

gg_pca_regions = cowplot::plot_grid(gg_pca_wle , gg_pca_cb, nrow = 2,
                                    labels = c("Lake Erie", "Chesapeake Bay"))
#gg_pca_regions

gg_pca_wle
gg_pca_cb

```

### Drivers and loadings

```{r v2-pc_loadings}
get_pc_values = function(dat){
  
  pca = fit_pca_function(dat)
  
  x = pca$pca_int$rotation
  x2 = 
    x %>% 
    as.data.frame() %>% 
    dplyr::select(PC1) %>% 
    arrange(desc(PC1)) %>% 
    rownames_to_column("variable") %>% 
    mutate(variable = fct_reorder(variable, (PC1)))

  x2
}

pc_overall = get_pc_values(data_wide_PCA2) %>% mutate(region = "combined")
pc_wle = get_pc_values(data_wide_PCA2 %>% filter(region == "Erie")) %>% mutate(region = "Erie")
pc_cb = get_pc_values(data_wide_PCA2 %>% filter(region == "Chesapeake")) %>% mutate(region = "Chesapeake")

```

```{r v2-pc_gg, fig.height=8, fig.width=6}

pc_all = 
  bind_rows(pc_overall, pc_wle, pc_cb) %>% 
  mutate(variable = fct_reorder(variable, (PC1)))

overall = 
  pc_all %>% 
  filter(region == "combined") %>% 
  mutate(variable = fct_reorder(variable, abs(PC1))) %>% 
  ggplot(aes(x = abs(PC1), y = variable))+
  geom_point(size = 5, stroke = 1, aes(shape = region, fill = region))+
  scale_fill_manual(values = c("#16879C", "#BB281E" ))+
  scale_shape_manual(values = c(23, 21))+
  
  xlim(-0.4, 0.4)+
  geom_vline(xintercept = 0)+
  labs(y = "")+
  theme_kp()

non_absolute = 
  pc_all %>% 
  mutate(variable = fct_reorder(variable, (PC1))) %>% 
  filter(region != "combined") %>% 
  ggplot(aes(x = PC1, y = variable))+
  geom_point(size = 5, stroke = 1, aes(shape = region, fill = region))+
  scale_fill_manual(values = c("#16879C", "#BB281E" ))+
  scale_shape_manual(values = c(23, 21))+
  
  xlim(-0.4, 0.4)+
  geom_vline(xintercept = 0)+
  labs(y = "")+
  theme_kp()

pc_all %>% 
  filter(region != "combined") %>% 
  mutate(variable = fct_reorder(variable, abs(PC1))) %>% 
  ggplot(aes(x = abs(PC1), y = variable))+
  geom_point(size = 5, stroke = 1, aes(shape = region, fill = region))+
  scale_fill_manual(values = c("#16879C", "#BB281E" ))+
  scale_shape_manual(values = c(23, 21))+
  labs(y = "",
       x = "|PC1|")+
  theme_kp()

```




## 1b. PERMANOVA

```{r}
library(vegan)

adonis2((data_wide_PCA2 %>% dplyr::select(where(is.numeric)) %>% drop_na()) ~ 
         (region + transect + horizon + site)^2, 
       data = data_wide_PCA2 %>% drop_na)

```


## 2. Each analyte

```{r v2-scaled_gg1, fig.height = 8, fig.width = 7, eval=FALSE}
data_long = 
  data_combined_wide %>% 
  rename(Cl = Chloride,
         SO4 = Sulfate) %>% 
  pivot_longer(cols = -c(sample_label, region, site, transect, tree_number, horizon)) %>% 
  filter(!is.na(value))

data_scaling_max_min = 
  data_long %>% 
  filter(transect != "transition") %>% 
  group_by(region, site, transect, horizon, name) %>% 
  dplyr::summarise(value = mean(value)) %>% 
  group_by(region, site, horizon, name) %>% 
  dplyr::summarise(max = max(value, na.rm = T),
                   min = min(value, na.rm = T))

data_scaled2 = 
  data_long %>% 
  group_by(region, site, transect, horizon, name) %>% 
  dplyr::summarise(value = mean(value)) %>% 
  left_join(data_scaling_max_min) %>% 
  mutate(scaled = (value - min) / (max - min)) %>% 
  dplyr::select(region, site, transect, horizon, name, scaled) %>%
  pivot_wider(names_from = "transect", values_from = "scaled") %>% 
  mutate(correction = case_when(upland < marsh ~ 1,
                                upland > marsh ~ -1)) %>% 
  pivot_longer(cols = c(upland, marsh, transition), names_to = "transect", values_to = "scaled") %>% 
  mutate(scaled = scaled * correction,
         scaled = case_when(transect == "upland" ~ 0,
                            transect == "marsh" ~ 1,
                            TRUE ~ scaled),
         scaled2 = case_when(scaled > 4 ~ 4,
                             scaled < -1 ~ -1,
                             TRUE ~ scaled),
         label = case_when(scaled > 4 | scaled < -1 ~ round(scaled,1))) %>% 
  # order analytes
  mutate(name = factor(name, levels = c("TC", "TN", "TS", "SOM",
                                        "pH", "spConductance",
                                        "WEOC", "DIC",
                                        "Fe", "P",
                                        "Ca", "Mg", "Na", "K", "Al", "CEC",
                                        "NH4N", "NO3N", "Cl", "SO4")),
         site = factor(site, levels = c("CRC", "PTR", "OWC",
                                        "GCW", "MSM", "GWI")))

data_scaled2 %>%
  ggplot(aes(x = scaled2, y = name))+
  geom_segment(aes(x = 0, xend = scaled2, yend = name), 
               color = "black", linetype = "dashed", linewidth = 0.2)+
  geom_segment(aes(x = 0, xend = 1, yend = name), color = "black")+
  geom_point(data = data_scaled2 %>% filter(transect != "transition"),
             color = "black",
             size = 1)+
  geom_point(data = data_scaled2 %>% filter(transect == "transition"), 
             size = 4, aes(color = site), stroke = 1, shape = 21, fill = "white")+
  annotate("text", label = "U", x = 0, y = 21)+
  annotate("text", label = "M", x = 1, y = 21)+
  annotate("text", label = "", x = 1, y = 21.5)+
  xlim(-1, 5)+
  scale_y_discrete(limits = rev)+
  scale_shape_manual(breaks = c("CRC", "PTR", "OWC", "GCW", "MSM", "GWI"), 
                     values = c(21, 22, 24, 21, 22, 24))+
  labs(x = "",
       y = "",
       shape = "transition soils at")+
  facet_wrap(~region)+
  theme_kp()+
  theme(panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "right",
        legend.background = element_blank()
  )

```

### Normalized values

```{r v2-scaled_gg2, fig.height = 8, fig.width = 8, eval=FALSE}
data_long_all = 
  data_combined_wide %>% 
  dplyr::select(-c(TN, CEC, K, Mg, Sulfate, NO3N, pH, spConductance, SOM, DIC, Al)) %>% 
  pivot_longer(cols = -c(sample_label, region, site, transect, tree_number, horizon)) %>% 
  filter(!is.na(value))

data_scaled_NEW = 
  data_long_all %>% 
  group_by(region, site, horizon, transect, name) %>% 
  dplyr::summarise(value_scaled = median(value)) %>% 
  group_by(region, site, horizon, name) %>% 
  dplyr::mutate(value_scaled = scales::rescale(value_scaled)) %>% 
  mutate(transect = factor(transect, levels = c("upland", "transition", "wetland"))) %>% 
  mutate(name = factor(name, levels = c("TC", "TS", "WEOC",
                                        "Ca", "Na", "Chloride",
                                        "NH4N", "Fe", "P"))) 

data_scaled_NEW %>% 
  ggplot(aes(x = transect, y = value_scaled, group = site, color = site))+
  geom_line(linewidth = 1) + geom_point(size = 2)+
  facet_wrap( ~ name)+
  scale_color_manual(breaks = c("CRC", "PTR", "OWC",
                                "GCW", "MSM", "GWI"),
                     values = c("#d73027", "#fc8d59", "#fdbb84", 
                                "#74a9cf", "#2b8cbe", "#045a8d"))+
  scale_x_discrete(labels = c("U", "T" , "M" ))+
  labs(x = "Transect", y = "Normalized concentration")+
  theme_kp()+
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank())

```

```{r v2-scaled_gg2_split, fig.height = 10, fig.width = 14, eval=FALSE}
library(ggh4x) # for nested facets
# https://teunbrand.github.io/ggh4x/reference/facet_nested.html

data_scaled_NEW %>% 
  ggplot(aes(x = transect, y = value_scaled, group = site, color = site))+
  geom_line(linewidth = 1) + geom_point(size = 2)+
#  facet_wrap( ~ name)+
  facet_nested_wrap(~ name + region, ncol = 6,
                    nest_line = element_line(colour = "grey"))+ 
  scale_color_manual(breaks = c("CRC", "PTR", "OWC",
                                "GCW", "MSM", "GWI"),
                     values = c("#d73027", "#fc8d59", "#fdbb84", 
                                "#74a9cf", "#2b8cbe", "#045a8d"))+
  scale_x_discrete(labels = c("U", "T" , "M" ))+
  labs(x = "Transect", y = "Normalized concentration")+
  theme_kp()+
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank())
```

### only select analytes

```{r v2-scaled_gg2_split-NEW, fig.height = 13, fig.width = 12}
library(ggh4x) # for nested facets
# https://teunbrand.github.io/ggh4x/reference/facet_nested.html

data_scaled_NEW2 = 
  data_scaled_NEW %>% 
  filter(name %in% c("WEOC", "TS", "Na", "Chloride", "Fe", "P", "NH4N")) %>% 
    mutate(name = factor(name, levels = c("TC", "TS", "WEOC",
                                        "Ca", "Na", "Chloride",
                                        "Fe", "P", "NH4N"))) 

data_scaled_NEW2 %>% 
  ggplot(aes(x = transect, y = value_scaled, group = site, color = site))+
  geom_line(linewidth = 1) + geom_point(size = 4, aes(shape = site, fill = site), color = "black")+
#  facet_wrap( ~ name)+
  facet_nested_wrap(~ name + region, ncol = 4,
                    nest_line = element_line(colour = "grey"))+ 
  scale_color_manual(breaks = c("CRC", "PTR", "OWC",
                                "GCW", "MSM", "GWI"),
                     values = c("#d73027", "#fc8d59", "#fdbb84", 
                                "#74a9cf", "#2b8cbe", "#045a8d"))+
    scale_fill_manual(breaks = c("CRC", "PTR", "OWC",
                                "GCW", "MSM", "GWI"),
                     values = c("#d73027", "#fc8d59", "#fdbb84", 
                                "#74a9cf", "#2b8cbe", "#045a8d"))+
  scale_shape_manual(breaks = c("CRC", "PTR", "OWC",
                                "GCW", "MSM", "GWI"),
                     values = c(21, 23, 24, 21, 23, 24))+
  scale_x_discrete(labels = c("U", "T" , "M" ))+
  scale_y_continuous(breaks = c(0, 0.5, 1), labels = c(0, "" , 1))+
  labs(x = "Transect", y = "Scaled concentration
       ")+
  theme_kp()+
  theme(#axis.text.y = element_blank(),
        panel.grid = element_blank()
        )

```


```{r v2-scaled_gg2_gwi, fig.height = 8, fig.width = 8, eval=FALSE}
data_scaled_NEW %>% 
  filter(site == "GWI") %>% 
  ggplot(aes(x = transect, y = value_scaled, group = site, color = site))+
  geom_line(linewidth = 1) + geom_point(size = 2)+
  facet_wrap( ~ name )+
  scale_color_manual(breaks = c("CRC", "PTR", "OWC",
                                "GCW", "MSM", "GWI"),
                     values = c("#d73027", "#fc8d59", "#fdbb84", 
                                "#74a9cf", "#2b8cbe", "#045a8d"))+
  scale_x_discrete(labels = c("U", "T" , "M" ))+
  scale_y_continuous(breaks = c(0, 0.5, 1), labels = c(0, "" , 1))+
  labs(x = "Transect", y = "Scaled concentration
       ")+
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank())

```


# Specific analytes

```{r analytesx-2, fig.height = 4, fig.width = 8, eval=FALSE}
data_combined_wide %>% 
  mutate(transect = factor(transect, levels = c("upland", "transition", "marsh"))) %>% 
  ggplot(aes(x = transect, y = Fe))+
  geom_violin(aes(fill = region), alpha = 0.6)+
  geom_jitter(width = 0.1)+
  labs(x = "",
       y = "Extractable Fe, μg/g")+
  facet_wrap(~region)+
#  scale_fill_manual(values = c("darkblue", "red"))+
  scale_fill_manual(values = pnw_palette("Bay", 2))+
  theme(legend.position = "none")

data_combined_wide %>% 
  mutate(transect = factor(transect, levels = c("upland", "transition", "marsh"))) %>% 
  ggplot(aes(x = transect, y = P))+
  geom_violin(aes(fill = transect), alpha = 0.4)+
  geom_jitter(width = 0.1)+
  labs(x = "",
       y = "Extractable P, μg/g")+
  facet_wrap(~region)+
  scale_fill_manual(values = pal_transect)+
  theme(legend.position = "none")
```


```{r analytesx-3, fig.height = 10, fig.width = 8}


plot_transect_as_x = function(data, YLAB = "", TITLE = "", SUBTITLE = "", SCALES = "free_x"){
  
  data = data %>% mutate(transect = factor(transect, levels = c("upland", "transition", "marsh"))) %>% 
    filter(!is.na(value))
  
  fit_lme_hsd_transect = function(dat){
    # this function will assign post-hoc HSD letters to the transect
    # use lme4::lmer -> multcomp::glht -> multcomp::cld
    library(multcomp)
    
    lmer = lme4::lmer(value ~ transect + (1|site), data = dat)
    h = summary(glht(lmer, linfct = mcp(transect = "Tukey")), test = adjusted("holm"))
    x = cld(h, decreasing = TRUE) # decreasing order of HSD letters
    x$mcletters$monospacedLetters %>% # sigh
      as.data.frame() %>% 
      rownames_to_column("transect") %>% 
      rename(groups = ".") %>% 
      mutate(groups = str_remove_all(groups, " "),
             groups = toupper(groups))
    
  }
  
  # make summary table for HSD letters ----
  hsd_transect_overall = 
    data %>% 
    group_by(region) %>% 
    do(fit_lme_hsd_transect(.))
  
  ## then calculate the y-axis position for the labels
  lme_y =
    data %>% 
    #group_by(region) %>% 
    dplyr::summarise(max = max(value, na.rm =T),
                     y = max + max/5) %>% 
    ungroup()
  
  ## combine them
  lme_for_graphs = 
    hsd_transect_overall %>% 
    cross_join(lme_y %>% dplyr::select(-max))
  
  #
  # graphs ----
  
  ggplot(data,
         aes(x = transect,
             y = value
             #shape = horizon,
             #alpha = horizon
         )) +
    # plot points
    
    geom_violin(aes(fill = region), alpha = 0.4)+
    geom_jitter(width = 0.1)+
    geom_text(data = lme_for_graphs, aes(y = y, label = groups), size = 5)+
    labs(x = "",
         y = "Extractable P, μg/g")+
    facet_wrap(~region)+
    scale_fill_manual(values = pnw_palette("Bay", 2))+
    labs(x = "",
         y = YLAB,
         title = TITLE,
         subtitle = SUBTITLE,
         shape = "Site",
         alpha = "Horizon",
         color = "Site")+
    theme(legend.position = "none")+
    NULL
  
  
}


gg_fe = plot_transect_as_x(data_combined_wide %>% rename(value = Fe),
                   YLAB = "Extractable Fe, μg/g")

gg_p = plot_transect_as_x(data_combined_wide %>% rename(value = P),
                   YLAB = "Extractable P, μg/g")

gg_tc = plot_transect_as_x(data_combined_wide %>% rename(value = TC),
                   YLAB = "Total Carbon, %")


cowplot::plot_grid(gg_fe, gg_p, ncol = 1)

```

```{r analytesx-4, fig.height = 15, fig.width = 8, eval=FALSE}
cowplot::plot_grid(gg_tc, gg_fe, gg_p, ncol = 1)
```



## Chesapeake-only plots for GWI
```{r analytes-gwi, fig.height = 10, fig.width = 5}

# plot Specific Conductance
gg_spc =
  data_combined_subset %>% filter(grepl("spCond", name)) %>% filter(region == "Chesapeake") %>% 
  ggplot(aes(x = transect, y = value)) +
    # plot points
    geom_point(aes(group = site, color = site),
               size = 2.5, stroke = 1, position = position_dodge(width = 0.4))+
    scale_alpha_manual(values = c(1, 0.3))+
    scale_color_manual(breaks = c("CRC", "PTR", "OWC", "GCW", "MSM", "GWI"), 
                       values = c('#ED6e85', '#7f4420', '#ffc115', '#90BE6D', '#03045E', '#00B4D8'))+
    theme_kp()+
    labs(x = "",
         y = "Specific Conductance, mS/cm",
         shape = "Site",
         color = "Site")+
    theme(legend.position = c(0.2, 0.8), legend.box = "vertical")+
    NULL


# plot Chloride
gg_cl = 
  data_combined_subset %>% filter(grepl("Chloride", name)) %>% filter(region == "Chesapeake") %>% 
  ggplot(aes(x = transect, y = value)) +
    # plot points
    geom_point(aes(group = site, color = site),
               size = 2.5, stroke = 1, position = position_dodge(width = 0.4))+
    scale_alpha_manual(values = c(1, 0.3))+
    scale_color_manual(breaks = c("CRC", "PTR", "OWC", "GCW", "MSM", "GWI"), 
                       values = c('#ED6e85', '#7f4420', '#ffc115', '#90BE6D', '#03045E', '#00B4D8'))+
    theme_kp()+
    labs(x = "",
         y = "Chloride, meq/100g",
         shape = "Site",
         color = "Site")+
    theme(legend.position = c(0.2, 0.8), legend.box = "vertical")+
    NULL


cowplot::plot_grid(gg_spc, gg_cl, ncol = 1)

```



## Water retention curves

```{r gg_hyprop, fig.height=8, fig.width=10}
library(ggh4x)
 
tar_load(wrc_processed)

wrc_processed %>% 
  reorder_site() %>% 
  reorder_transect() %>% 
    filter(kpa_fit >= 0 | kpa_eval >= 0) %>% 
    mutate(region = factor(region, levels = c("Erie", "Chesapeake"))) %>% 
    ggplot(aes(y = water_content_vol_percent, color = transect))+
    geom_line(aes(x = kpa_fit))+
    geom_point(aes(x = kpa_eval), shape = 1)+
    scale_x_log10(labels = scales::comma)+
  scale_color_manual(values = rev(soilpalettes::soil_palette("redox2", 3)))+
  labs(x = "Water potential, kPa",
       y = "Water content, % v/v",
       color = "")+
  #    facet_wrap(~region + site)+
  facet_nested_wrap(region ~ site)+
  theme_kp()
```


## Elevation 

```{r, gg_elevation, fig.height=8, fig.width=10}

elevation = read.csv("1-data/synoptic-elevations.csv", na = "")
elevation_processed = 
  elevation %>% 
  mutate(transect = case_match(transect, "wetland" ~ "marsh", .default = transect),
         transect = factor(transect, levels = c("water edge", "marsh", "transition", "upland"))) %>% 
  reorder_site()


gg_wle = 
  elevation_processed %>% 
  filter(region == "Erie") %>% 
  ggplot(aes(x = distance_to_water_m, y = elev_m, color = transect, linetype = site))+
  geom_line(color = "black", show.legend = F)+
  geom_point(size = 4)+
  scale_color_manual(values = c("grey", "#2E5894", "#FFB200", "#96001B"),
                     breaks = c("water edge", "marsh", "transition", "upland"))+
  scale_linetype_manual(values = c("dashed", "solid", "solid"),
                     breaks = c("CRC", "PTR", "OWC"))+
  facet_nested_wrap(region ~ site)+
  labs(x = "",
       y = "Elevation, m
       ",
       color = "")+
#  theme(legend.position = c(0.1,0.61))+
  NULL


gg_cb = 
  elevation_processed %>% 
  filter(region == "Chesapeake") %>%
  filter(site != "Sweet Hall Marsh") %>% 
  ggplot(aes(x = distance_to_water_m, y = elev_m, color = transect))+
  geom_line(color = "black")+
  geom_point(size = 4)+
  scale_color_manual(values = c("grey", "#2E5894", "#FFB200", "#96001B"),
                     breaks = c("water edge", "marsh", "transition", "upland"))+
  facet_nested_wrap(region ~ site)+
  labs(x = "Distance to water, m",
       y = "Elevation, m
       ",
       color = "")

ggpubr::ggarrange(gg_wle, gg_cb, common.legend = T, nrow = 2)

```

--- 

## SOIL MOISTURE SENSORS

Processed data are available here in this repository. Raw data are available on Google Drive (access needed).

### Soil water content for 2022-23

```{r gg_vwc, fig.height=8, fig.width=10}
# plot vwc

vwc_data %>% 
  filter(value > 0) %>% 
  reorder_site() %>% 
  reorder_transect() %>% 
  ggplot(aes(x = datetime_est, y = value, color = transect))+
  geom_line()+
  #  facet_wrap(~ site + transect)+
  facet_nested_wrap(~region + site,
                    nest_line = element_line(colour = "grey")) +
  scale_color_manual(breaks = c("upland", "transition", "wte", "marsh"), 
                     values = pal_transect)+
  labs(x = "", 
       y = "Water content (% v/v)",
       color = "")+
  theme_kp()+
  theme(axis.text.x = element_text(size = 14, angle = 45, hjust = 1),
        panel.grid = element_blank())

```

### Summarized soil water content

```{r}
vwc_means %>% reorder_transect() %>% knitr::kable()
```


### Water level in soil

When water level is positive (above surface), it means the soil is flooded.

```{r gg_water_level, fig.height=8, fig.width=10}

troll %>% 
  reorder_transect() %>% 
  ggplot(aes(x = datetime_est, y = wl_below_surface_m, color = transect))+
  geom_hline(yintercept = 0, alpha = 0.8)+
  geom_line(aes(y = rollmean), linewidth = 1)+
  facet_nested_wrap(~region + site,
                    nest_line = element_line(colour = "grey"))+ 
  scale_color_manual(breaks = c("upland", "transition", "wte", "marsh"), 
                     values = pal_transect)+
  labs(x = "",
       y = "Water level below surface (m)",
       color = "")+
  theme_kp()+
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(size = 14, angle = 45, hjust = 1))   ## 

```


### Water table summary

```{r}
water_table %>% reorder_transect() %>% knitr::kable()
```


### Calculating time flooded (% of the year)

```{r}
percent_flooded %>% reorder_transect() %>% knitr::kable()
```






---

## Session Info 

<details>
  <summary> Session Info </summary>

Date run: `r Sys.Date()`

```{r}
sessionInfo()
```

</details>